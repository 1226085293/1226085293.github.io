---
title: åœ¨ Windows ä¸‹ä½¿ç”¨ BGFX(WASM) +JS æ¸²æŸ“ä¸‰è§’å½¢
date: 2025-07-15 16:22:00
image: /static/blog/c47eaf49-8c97-4b28-b18b-db12dfcbf510.png
summary: å¤šå¹³å° BGFX æ¸²æŸ“å¼•æ“ä¸ JS çš„åˆæ­¥äº¤äº’å®éªŒ
tags:
  - å¼€å‘å·¥å…·
---
# å¿…è¦æ¡ä»¶

- æˆåŠŸæ„å»º bgfx çš„ wasm ç¤ºä¾‹é¡¹ç›®çš„ç¯å¢ƒ


# å‰ç½®å·¥ä½œ

### æ„å»º shadercï¼ˆbgfxçš„å¤šå¹³å°ç€è‰²å™¨æ„å»ºå·¥å…·ï¼‰

1. å®‰è£… MSYS2
å®˜ç½‘ï¼šhttps://www.msys2.org/

2. å®‰è£…æ­£ç¡®å·¥å…·é“¾
å¯åŠ¨ MSYS2 ç›®å½•ä¸‹çš„ mingw64.exeï¼Œä¹Ÿå¯ä»¥åœ¨å¯åŠ¨èœå•æœç´¢ MSYS2 MINGW64ï¼Œç„¶ååœ¨æ‰“å¼€çš„ç»ˆç«¯å†…æ‰§è¡Œä»¥ä¸‹å‘½ä»¤
`pacman -S yu`
`pacman -S mingw-w64-x86_64-gcc mingw-w64-x86_64-cmake mingw-w64-x86_64-make ninja`

3. ç”Ÿæˆ projects
åœ¨ bgfx ç›®å½•ä¸‹æ‰§è¡Œ make

4. ä¿®æ”¹å¼•ç”¨è·¯å¾„
è¿›å…¥ \`bgfx\\.build\\projects\\gmake-mingw-gcc\` ç›®å½•ï¼Œå°†æ‰€æœ‰ make æ–‡ä»¶å†…çš„ \`$(MINGW)/bin/\` æ›¿æ¢ä¸º \`$(MINGW)/mingw64/bin/\`

5. æ„å»º shaderc
åœ¨ mingw64 ç»ˆç«¯æ‰§è¡Œ \`make shaderc config=release64\`ï¼Œç­‰å¾…æ„å»ºå®Œæˆï¼ˆå¤§æ¦‚åŠå°æ—¶å·¦å³ï¼‰
> æ„å»ºå®Œæˆçš„ exe åœ¨ \`bgfx\\.build\\win64_mingw-gcc\\bin\` ç›®å½•ä¸‹

# æ–°å»ºæºç 

## ç›®å½•ç»“æ„
![](/static/blog/17f25a61-7226-43a1-950c-fdfc864818e9.png)

## main.cpp

```
#include <bgfx/bgfx.h>
#include <bgfx/platform.h>
#include <bx/math.h>
#include <emscripten.h>
#include <emscripten/html5.h>
#include <cstdio>
#include <cstdint>


// é¡¶ç‚¹ç»“æ„å®šä¹‰
struct PosColorVertex {
Â  Â  float x, y, z;
Â  Â  uint32_t abgr;
};


// ä¸‰è§’å½¢é¡¶ç‚¹æ•°æ®
static PosColorVertex vertices[] = {
Â  Â  { 0.0f, Â 0.5f, 0.0f, 0xff0000ff },
Â  Â  { 0.5f, -0.5f, 0.0f, 0xff00ff00 },
Â  Â  {-0.5f, -0.5f, 0.0f, 0xffff0000 }
};


// å…¨å±€èµ„æºå¥æŸ„
static bgfx::VertexLayout vertexLayout;
static bgfx::VertexBufferHandle vbh = BGFX_INVALID_HANDLE;
static bgfx::ProgramHandle program = BGFX_INVALID_HANDLE;


bgfx::ShaderHandle loadShader(const char* path) {
Â  Â  FILE* file = fopen(path, "rb");
Â  Â  if (!file) {
Â  Â  Â  Â  printf("âŒ Failed to open shader: %s\n", path);
Â  Â  Â  Â  return BGFX_INVALID_HANDLE;
Â  Â  }


Â  Â  fseek(file, 0, SEEK_END);
Â  Â  long size = ftell(file);
Â  Â  rewind(file);


Â  Â  const bgfx::Memory* mem = bgfx::alloc(size);
Â  Â  fread(mem->data, 1, size, file);
Â  Â  fclose(file);


Â  Â  printf("ğŸ“¦ Loading shader: %s\n", path);
Â  Â  return bgfx::createShader(mem);
}


extern "C" {
// åˆå§‹åŒ– BGFX
EMSCRIPTEN_KEEPALIVE
void initBgfx()
{
Â  Â  printf("ğŸ”¥ Initializing bgfx...\n");
Â  Â  bgfx::renderFrame();


Â  Â  bgfx::Init init;
Â  Â  init.type = bgfx::RendererType::Count;
Â  Â  init.platformData.nwh = (void*)"#canvas";
Â  Â  init.platformData.ndt = NULL;
Â  Â  init.platformData.type = bgfx::NativeWindowHandleType::Default;
Â  Â  init.resolution.width = 800;
Â  Â  init.resolution.height = 600;
Â  Â  init.resolution.reset = BGFX_RESET_VSYNC;


Â  Â  if (!bgfx::init(init)) {
Â  Â  Â  Â  printf("âŒ bgfx::init failed!\n");
Â  Â  Â  Â  return;
Â  Â  }


Â  Â  // Enable debug text.
Â  Â  bgfx::setDebug(BGFX_DEBUG_TEXT);
Â  Â  // Set view 0 clear state.
Â  Â  bgfx::setViewClear(0
Â  Â  Â  Â  , BGFX_CLEAR_COLOR|BGFX_CLEAR_DEPTH
Â  Â  Â  Â  , 0x303030ff
Â  Â  Â  Â  , 1.0f
Â  Â  Â  Â  , 0
Â  Â  Â  Â  );



Â  Â  vertexLayout.begin()
Â  Â  Â  Â  .add(bgfx::Attrib::Position, 3, bgfx::AttribType::Float)
Â  Â  Â  Â  .add(bgfx::Attrib::Color0, 4, bgfx::AttribType::Uint8, true)
Â  Â  Â  Â  .end();


Â  Â  vbh = bgfx::createVertexBuffer(
Â  Â  Â  Â  bgfx::makeRef(vertices, sizeof(vertices)),
Â  Â  Â  Â  vertexLayout);


Â  Â  bgfx::ShaderHandle vsh = loadShader("shaders/vs_triangle.bin");
Â  Â  bgfx::ShaderHandle fsh = loadShader("shaders/fs_triangle.bin");


Â  Â  if (!bgfx::isValid(vsh) || !bgfx::isValid(fsh)) {
Â  Â  Â  Â  printf("âŒ Failed to load shaders.\n");
Â  Â  Â  Â  return;
Â  Â  }


Â  Â  program = bgfx::createProgram(vsh, fsh, true);
Â  Â  if (!bgfx::isValid(program)) {
Â  Â  Â  Â  printf("âŒ Failed to create program.\n");
Â  Â  }


Â  Â  printf("âœ… bgfx initialized.\n");
}


// æ¸²æŸ“ä¸€å¸§
EMSCRIPTEN_KEEPALIVE
void renderFrame()
{
Â  Â  if (!bgfx::isValid(vbh) || !bgfx::isValid(program)) {
Â  Â  Â  Â  printf("âš ï¸ Skipping frame (invalid handle)\n");
Â  Â  Â  Â  return;
Â  Â  }


Â  Â  // è§†å›¾ / æŠ•å½±çŸ©é˜µ
Â  Â  float view[16];
Â  Â  bx::mtxLookAt(view, {0.0f, 0.0f, -3.0f}, {0.0f, 0.0f, 0.0f});


Â  Â  float proj[16];
Â  Â  bx::mtxProj(proj, 60.0f, 800.0f / 600.0f, 0.1f, 100.0f, bgfx::getCaps()->homogeneousDepth);
Â  Â  bgfx::setViewTransform(0, view, proj);


Â  Â  bgfx::setViewRect(0, 0, 0, 800, 600);
Â  Â  bgfx::setViewClear(0, BGFX_CLEAR_COLOR | BGFX_CLEAR_DEPTH, 0x303030ff, 1.0f, 0);
Â  Â  bgfx::touch(0); // ç¡®ä¿ view è¢«æ¸…å±


Â  Â  // æ¨¡å‹çŸ©é˜µ
Â  Â  float mtx[16];
Â  Â  bx::mtxIdentity(mtx);
Â  Â  bgfx::setTransform(mtx);


Â  Â  // ç»‘å®šé¡¶ç‚¹ç¼“å†²
Â  Â  bgfx::setVertexBuffer(0, vbh);


Â  Â  // æ¸²æŸ“çŠ¶æ€ï¼šå†™é¢œè‰² + å…³å‰”é™¤
Â  Â  bgfx::setState(BGFX_STATE_WRITE_RGB | BGFX_STATE_WRITE_A | BGFX_STATE_DEPTH_TEST_LESS);


Â  Â  bgfx::submit(0, program);
Â  Â  bgfx::frame();
}


// èµ„æºæ¸…ç†
EMSCRIPTEN_KEEPALIVE
void shutdown()
{
Â  Â  printf("ğŸ”» Shutting down...\n");
Â  Â  if (bgfx::isValid(vbh)) bgfx::destroy(vbh);
Â  Â  if (bgfx::isValid(program)) bgfx::destroy(program);
Â  Â  bgfx::shutdown();
}


}


int main() {
Â  Â  return 0;
}
```

## index.html

```
<!DOCTYPE html>
<html lang="en">
Â  Â  <head>
Â  Â  Â  Â  <meta charset="UTF-8" />
Â  Â  Â  Â  <title>bgfx WASM Demo</title>
Â  Â  Â  Â  <style>
Â  Â  Â  Â  Â  Â  html,
Â  Â  Â  Â  Â  Â  body {
Â  Â  Â  Â  Â  Â  Â  Â  margin: 0;
Â  Â  Â  Â  Â  Â  Â  Â  padding: 0;
Â  Â  Â  Â  Â  Â  Â  Â  background: #303030;
Â  Â  Â  Â  Â  Â  Â  Â  overflow: hidden;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  canvas {
Â  Â  Â  Â  Â  Â  Â  Â  width: 100vw;
Â  Â  Â  Â  Â  Â  Â  Â  height: 100vh;
Â  Â  Â  Â  Â  Â  Â  Â  display: block;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  </style>
Â  Â  </head>
Â  Â  <body>
Â  Â  Â  Â  <canvas
Â  Â  Â  Â  Â  Â  id="canvas"
Â  Â  Â  Â  Â  Â  width="800"
Â  Â  Â  Â  Â  Â  height="600"
Â  Â  Â  Â  Â  Â  style="background: red"
Â  Â  Â  Â  ></canvas>
Â  Â  Â  Â  <script>
Â  Â  Â  Â  Â  Â  var Module = {
Â  Â  Â  Â  Â  Â  Â  Â  canvas: document.getElementById("canvas"),
Â  Â  Â  Â  Â  Â  Â  Â  onRuntimeInitialized() {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.log("âœ… WASM ready");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // åˆå§‹åŒ– bgfx
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Module._initBgfx();


Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  FS.readdir("/shaders");


Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // å¼€å§‹æ¸²æŸ“å¾ªç¯
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  function loop() {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Module._renderFrame();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  requestAnimationFrame(loop);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }


Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  requestAnimationFrame(loop);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  window.addEventListener("beforeunload", Module._shutdown);
Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  </script>
Â  Â  Â  Â  <script src="bgfx_demo.js"></script>
Â  Â  </body>
</html>
```

## shaders/varying.def.sc

```
vec3 a_position  : POSITION;
vec4 a_color0    : COLOR0;

vec4 v_color0    : COLOR0;
```

## shaders/fs_triangle.sc

```
$input v_color0

#include <bgfx_shader.sh>

void main()
{
    gl_FragColor = v_color0;
}
```

## shaders/vs_triangle.sc

```
$input a_position, a_color0
$output v_color0

#include <bgfx_shader.sh>

void main()
{
    gl_Position = mul(u_modelViewProj, vec4(a_position, 1.0));
    v_color0 = a_color0;
}
```

# å¼€å§‹æ„å»º

## 1. æ„å»ºç€è‰²å™¨

å…ˆæŠŠ **shadercRelease.exe** å’Œ  **bgfx/src/bgfx_shader.sh** æ‹·è´åˆ° `src/shaders` ç›®å½•ä¸‹

ç„¶ååœ¨ PowelShell ä¸­ cd åˆ° shaders ç›®å½•ï¼Œæ‰§è¡Œä¸‹é¢ä¸¤æ¡å‘½ä»¤

```
./shadercRelease.exe -f fs_triangle.sc -o fs_triangle.bin -i .   --type fshader --platform wasm --profile 120 --varyingdef varying.def.sc
./shadercRelease.exe -f vs_triangle.sc -o vs_triangle.bin -i .   --type vshader --platform wasm --profile 120 --varyingdef varying.def.sc
```

å¦‚æœæ²¡æœ‰æŠ¥é”™åˆ™æ‰§è¡ŒæˆåŠŸ

## 2. æ„å»º wasm

åœ¨ PowelShell ä¸­ cd åˆ°æ ¹ç›®å½•ï¼ˆbgfx çš„ä¸Šçº§ç›®å½•ï¼‰ï¼Œç„¶åæ‰§è¡Œä»¥ä¸‹å‘½ä»¤

```
./emsdk/emsdk_env
emcc ./src/main.cpp `
  -o ./src/bgfx_demo.js `
  -I./bgfx/include `
  -I./bx/include `
  -I./bimg/include `
  ./bgfx/.build/wasm/bin/bgfxRelease.a `
  ./bgfx/.build/wasm/bin/bimgRelease.a `
  ./bgfx/.build/wasm/bin/bimg_decodeRelease.a `
  ./bgfx/.build/wasm/bin/bxRelease.a `
  -D BX_CONFIG_DEBUG=0 `
  -s WASM=1 `
  -s USE_WEBGL2=1 `
  -s FULL_ES3=1 `
  -s DISABLE_EXCEPTION_CATCHING=1 `
  -s MODULARIZE=0 `
  -s EXPORT_NAME="Module" `
  -s EXPORTED_FUNCTIONS='["_main","_renderFrame","_shutdown","_emscripten_webgl_create_context","_emscripten_webgl_make_context_current"]' `
  -s EXPORTED_RUNTIME_METHODS='["ccall","cwrap","FS"]' `
  -s ALLOW_MEMORY_GROWTH=1 `
  -s ASSERTIONS=2 `
  -s INITIAL_MEMORY=67108864 `
  -s MAX_WEBGL_VERSION=2 `
  -s MIN_WEBGL_VERSION=2 `
  -s FORCE_FILESYSTEM=1 `
  -s ENVIRONMENT=web `
  -s GL_ENABLE_GET_PROC_ADDRESS=1 `
  --preload-file ./src/shaders@/shaders `
  -std=c++20
```

æˆåŠŸåå³å¯çœ‹åˆ° src ç›®å½•ä¸‹çš„ bgfx_demo.js, bgfx_demo.data, bgfx_demo.wasm

ç„¶ååœ¨ src ç›®å½•æ‰§è¡Œ npx http-server å¯åŠ¨ http æœåŠ¡å™¨é¢„è§ˆ

![](/static/blog/c47eaf49-8c97-4b28-b18b-db12dfcbf510.png)
